<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>X Layer Inscription Launchpad - FairLaunchOkb</title>
    <link rel="icon" href="https://woofingjace.com/images/jace.png" type="image/x-icon">
    <style>
        body { background: #000000; font-family: Arial, sans-serif; margin: 0; padding: 20px; color: #ffffff; }
        .container { max-width: 800px; margin: 0 auto; background: #1a1a1a; padding: 20px; border-radius: 8px; }
        h1 { text-align: center; font-size: 24px; margin-bottom: 20px; }
        .section { margin-bottom: 20px; }
        label { display: block; margin-bottom: 5px; }
        input { width: 100%; padding: 8px; margin-bottom: 10px; background: #2d2d2d; border: 1px solid #444444; color: #ffffff; border-radius: 4px; }
        button { background: #333333; color: #ffffff; padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer; margin-right: 5px; }
        button:hover { background: #444444; }
        .status { margin-top: 10px; font-size: 14px; }
        .balance { margin: 10px 0; }
        .disabled { opacity: 0.5; pointer-events: none; }
        .contract-info { font-size: 14px; margin-bottom: 10px; }
        .deployed-contracts { margin-top: 20px; }
        .deployed-contracts div { margin-bottom: 5px; cursor: pointer; }
        .deployed-contracts div:hover { color: #00ff00; }
        .calc-buttons { margin: 10px 0; }
        .calc-buttons button { margin-right: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>X Layer Inscription Launchpad - FairLaunchOkb</h1>
        <div class="section">
            <button id="connectWallet" class="button">Connect Wallet</button>
            <div id="walletStatus" class="status">Not connected</div>
        </div>
        <div class="section">
            <label for="domainInput">Enter Domain (e.g., jace.okb):</label>
            <input type="text" id="domainInput" placeholder="e.g., jace.okb" disabled>
            <div id="addressResult" class="status"></div>
        </div>
        <div class="section">
            <label for="launchPadAddress">Enter JaceLaunchPad Address:</label>
            <input type="text" id="launchPadAddress" placeholder="e.g., 0x..." value="0x8969a8D57F82958BbD91bD19d49f1B4D98F0374b" disabled>
        </div>
        <div class="section">
            <label for="price">Price (ETH per unit):</label>
            <input type="number" id="price" placeholder="0.0" step="0.0001" disabled>
            <label for="amountPerUnits">Tokens per Unit:</label>
            <input type="number" id="amountPerUnits" placeholder="0" step="1" disabled>
            <label for="totalSupply">Total Supply (tokens):</label>
            <input type="number" id="totalSupply" placeholder="1000000" step="1" disabled>
            <div class="calc-buttons">
                <button onclick="setSupplyMultiplier(1)" disabled>1x</button>
                <button onclick="setSupplyMultiplier(2)" disabled>2x</button>
                <button onclick="setSupplyMultiplier(5)" disabled>5x</button>
            </div>
            <label for="launcher">Launcher Address:</label>
            <input type="text" id="launcher" placeholder="e.g., 0x..." disabled>
            <label for="uniswapRouter">Uniswap Router Address:</label>
            <input type="text" id="uniswapRouter" placeholder="e.g., 0x..." value="0xdf7837e3E180CeAdE46133946cb1c7c9ECB47F8E" disabled>
            <label for="uniswapFactory">Uniswap Factory Address:</label>
            <input type="text" id="uniswapFactory" placeholder="e.g., 0x..." value="0x40E9fC0A18ccfDc87C19A1bA5b7F84FC51879600" disabled>
            <label for="name">Token Name:</label>
            <input type="text" id="name" placeholder="e.g., JaceToken" disabled>
            <label for="symbol">Token Symbol:</label>
            <input type="text" id="symbol" placeholder="e.g., JACE" disabled>
            <label for="eachAddressLimitEthers">Per Address ETH Limit:</label>
            <input type="number" id="eachAddressLimitEthers" placeholder="0.0" step="0.0001" disabled>
            <label for="unitCount">Units for Limit Calculation:</label>
            <input type="number" id="unitCount" placeholder="10" step="1" disabled>
            <button id="calcLimitButton" onclick="calculateLimit()" disabled>Calculate Limit</button>
            <button id="launchButton" onclick="launchToken()" disabled>Launch Token</button>
            <div id="transactionStatus" class="status"></div>
        </div>
        <div class="section deployed-contracts">
            <h3>Deployed Token Contracts</h3>
            <div id="deployedContracts"></div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/web3@1.7.0/dist/web3.min.js"></script>
    <script>
        let web3, accounts, resolverContract, launchPadContract;

        const resolverAddress = '0x51AEfC36203F0B3612e15c168aDE8ec2401A1507';
        const resolverContractABI = [
            {"inputs":[{"internalType":"address","name":"contractAddress","type":"address"},{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"bindDomain","outputs":[],"stateMutability":"nonpayable","type":"function"},
            {"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"unbindDomain","outputs":[],"stateMutability":"nonpayable","type":"function"},
            {"inputs":[{"internalType":"address","name":"contractAddress","type":"address"},{"internalType":"string","name":"domainName","type":"string"}],"name":"getAddressByDomain","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"getDomainByAddress","outputs":[{"internalType":"string","name":"","type":"string"},{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"isDomainBound","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},
            {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":true,"internalType":"address","name":"contractAddress","type":"address"},{"indexed":false,"internalType":"uint256","name":"tokenId","type":"uint256"},{"indexed":false,"internalType":"string","name":"domainName","type":"string"}],"name":"DomainBound","type":"event"},
            {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":true,"internalType":"address","name":"contractAddress","type":"address"},{"indexed":false,"internalType":"uint256","name":"tokenId","type":"uint256"},{"indexed":false,"internalType":"string","name":"domainName","type":"string"}],"name":"DomainUnbound","type":"event"},
            {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":true,"internalType":"address","name":"contractAddress","type":"address"},{"indexed":false,"internalType":"uint256","name":"tokenId","type":"uint256"},{"indexed":false,"internalType":"string","name":"domainName","type":"string"}],"name":"Parsed","type":"event"},
            {"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"tokenBoundBy","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"addressToTokenId","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"}
        ];

        const launchPadABI = [
            {"inputs":[],"stateMutability":"nonpayable","type":"constructor"},
            {"inputs":[{"internalType":"uint256","name":"_price","type":"uint256"},{"internalType":"uint256","name":"_amountPerUnits","type":"uint256"},{"internalType":"uint256","name":"totalSupply","type":"uint256"},{"internalType":"address","name":"_luncher","type":"address"},{"internalType":"string","name":"_name","type":"string"},{"internalType":"string","name":"_symbol","type":"string"},{"internalType":"uint256","name":"_eachAddressLimitEthers","type":"uint256"}],"name":"launchOkb","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"nonpayable","type":"function"},
            {"inputs":[],"name":"launchLength","outputs":[{"internalType":"uint","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"uint256","name":"_idx","type":"uint256"}],"name":"launchDetail","outputs":[{"internalType":"address","name":"","type":"address"},{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"address","name":"","type":"address"},{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"address","name":"_token","type":"address"}],"name":"tokenLaunch","outputs":[{"internalType":"bool","name":"","type":"bool"},{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"}
        ];

        const xLayer = { chainId: 196, rpcUrl: 'https://rpc.xlayer.tech' };

        async function connectWallet() {
            if (!window.ethereum) {
                document.getElementById('walletStatus').innerText = 'Please install MetaMask.';
                return;
            }
            try {
                web3 = new Web3(window.ethereum);
                await window.ethereum.request({ method: 'eth_requestAccounts' });
                const chainId = await web3.eth.getChainId();
                if (chainId !== 196) {
                    await window.ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: '0xc4' }] });
                }
                accounts = await web3.eth.getAccounts();
                resolverContract = new web3.eth.Contract(resolverContractABI, resolverAddress);
                
                // Fetch domain name for the connected address
                let displayText = accounts[0].slice(0, 6) + '...' + accounts[0].slice(-4); // Default to address
                try {
                    const [domainName] = await resolverContract.methods.getDomainByAddress(accounts[0]).call();
                    if (domainName && domainName !== '') {
                        displayText = domainName;
                    }
                } catch (error) {
                    console.error('Error fetching domain:', error);
                }
                
                document.getElementById('walletStatus').innerText = `Connected: ${displayText}`;
                document.getElementById('launcher').value = accounts[0]; // Set launcher to connected address
                enableInputs(true);
                fetchDeployedContracts();
            } catch (error) {
                document.getElementById('walletStatus').innerText = 'Failed to connect: ' + error.message;
            }
        }

        function enableInputs(enabled) {
            document.getElementById('domainInput').disabled = !enabled;
            document.getElementById('launchPadAddress').disabled = !enabled;
            document.getElementById('price').disabled = !enabled;
            document.getElementById('amountPerUnits').disabled = !enabled;
            document.getElementById('totalSupply').disabled = !enabled;
            document.getElementById('launcher').disabled = !enabled;
            document.getElementById('uniswapRouter').disabled = !enabled;
            document.getElementById('uniswapFactory').disabled = !enabled;
            document.getElementById('name').disabled = !enabled;
            document.getElementById('symbol').disabled = !enabled;
            document.getElementById('eachAddressLimitEthers').disabled = !enabled;
            document.getElementById('unitCount').disabled = !enabled;
            document.getElementById('calcLimitButton').disabled = !enabled;
            document.getElementById('launchButton').disabled = !enabled;
            document.querySelectorAll('.calc-buttons button').forEach(btn => btn.disabled = !enabled);
        }

        async function resolveAddress() {
            if (!web3 || !accounts) {
                document.getElementById('addressResult').innerText = 'Please connect wallet first.';
                return;
            }
            const domain = document.getElementById('domainInput').value.trim();
            if (!domain) {
                document.getElementById('addressResult').innerText = '';
                return;
            }
            try {
                const address = await resolverContract.methods.getAddressByDomain(address(0), domain).call(); // Note: contractAddress should be one of the supported contracts
                document.getElementById('addressResult').innerText = address ? `Resolved Address: ${address}` : 'Domain not found or not bound.';
            } catch (error) {
                document.getElementById('addressResult').innerText = 'Error resolving address: ' + error.message;
            }
        }

        async function fetchDeployedContracts() {
            const launchPadAddress = document.getElementById('launchPadAddress').value.trim();
            if (!web3 || !accounts || !web3.utils.isAddress(launchPadAddress)) {
                document.getElementById('deployedContracts').innerText = 'Invalid launchpad address or wallet not connected.';
                return;
            }
            try {
                launchPadContract = new web3.eth.Contract(launchPadABI, launchPadAddress);
                const length = await launchPadContract.methods.launchLength().call();
                let contractsHtml = '';
                for (let i = 0; i < length; i++) {
                    const [tokenAddress, launchTime, launchType, spendToken, creator] = await launchPadContract.methods.launchDetail(i).call();
                    if (launchType === '1') { // Type 1 is Okb
                        const launchTimeDate = new Date(launchTime * 1000).toLocaleString();
                        contractsHtml += `<div onclick="copyToClipboard('${tokenAddress}')" title="Click to copy">${tokenAddress} (Launched: ${launchTimeDate}, Creator: ${creator.slice(0, 6)}...${creator.slice(-4)})</div>`;
                    }
                }
                document.getElementById('deployedContracts').innerHTML = contractsHtml || 'No deployed Okb tokens found.';
            } catch (error) {
                document.getElementById('deployedContracts').innerText = 'Error fetching deployed contracts: ' + error.message;
            }
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('Copied to clipboard: ' + text);
            }).catch(err => {
                console.error('Failed to copy: ', err);
            });
        }

        function setSupplyMultiplier(multiplier) {
            const baseSupply = 1000000; // Default base supply
            document.getElementById('totalSupply').value = baseSupply * multiplier;
        }

        function calculateLimit() {
            const price = parseFloat(document.getElementById('price').value) || 0;
            const unitCount = parseInt(document.getElementById('unitCount').value) || 10;
            const limit = price * unitCount * 0.1; // Suggest 10% of price per unit count
            document.getElementById('eachAddressLimitEthers').value = limit.toFixed(4);
        }

        async function launchToken() {
            if (!web3 || !accounts) {
                document.getElementById('transactionStatus').innerText = 'Please connect wallet first.';
                return;
            }
            const launchPadAddress = document.getElementById('launchPadAddress').value.trim();
            if (!web3.utils.isAddress(launchPadAddress)) {
                document.getElementById('transactionStatus').innerText = 'Invalid launchpad address.';
                return;
            }
            const price = document.getElementById('price').value;
            const amountPerUnits = document.getElementById('amountPerUnits').value;
            const totalSupply = document.getElementById('totalSupply').value;
            const launcher = document.getElementById('launcher').value;
            const uniswapRouter = document.getElementById('uniswapRouter').value;
            const uniswapFactory = document.getElementById('uniswapFactory').value;
            const name = document.getElementById('name').value;
            const symbol = document.getElementById('symbol').value;
            const eachAddressLimitEthers = document.getElementById('eachAddressLimitEthers').value;

            if (!price || !amountPerUnits || !totalSupply || !web3.utils.isAddress(launcher) || !web3.utils.isAddress(uniswapRouter) || !web3.utils.isAddress(uniswapFactory) || !name || !symbol || !eachAddressLimitEthers) {
                document.getElementById('transactionStatus').innerText = 'Please fill all fields with valid values.';
                return;
            }

            try {
                launchPadContract = new web3.eth.Contract(launchPadABI, launchPadAddress);
                const gas = await launchPadContract.methods.launchOkb(
                    web3.utils.toWei(price, 'ether'),
                    web3.utils.toWei(amountPerUnits, 'ether'),
                    web3.utils.toWei(totalSupply, 'ether'),
                    launcher,
                    name,
                    symbol,
                    web3.utils.toWei(eachAddressLimitEthers, 'ether')
                ).estimateGas({ from: accounts[0] });
                const tx = await launchPadContract.methods.launchOkb(
                    web3.utils.toWei(price, 'ether'),
                    web3.utils.toWei(amountPerUnits, 'ether'),
                    web3.utils.toWei(totalSupply, 'ether'),
                    launcher,
                    name,
                    symbol,
                    web3.utils.toWei(eachAddressLimitEthers, 'ether')
                ).send({ from: accounts[0], gas: Math.floor(gas * 1.2) });
                document.getElementById('transactionStatus').innerText = `Token launched successfully! Tx: ${tx.transactionHash}`;
                fetchDeployedContracts();
            } catch (error) {
                document.getElementById('transactionStatus').innerText = 'Launch failed: ' + error.message;
            }
        }

        document.getElementById('connectWallet').addEventListener('click', connectWallet);
        document.getElementById('domainInput').addEventListener('input', () => {
            if (web3 && accounts) resolveAddress();
        });
        document.getElementById('launchPadAddress').addEventListener('input', () => {
            if (web3 && accounts) fetchDeployedContracts();
        });
    </script>
</body>
</html>
